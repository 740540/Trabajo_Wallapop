filter {
  if "wallapop" in [tags] {
    
    # 1. Add organization metadata
    mutate {
      add_field => {
        "eventDst" => "192.168.153.2"
      }
    }
    
    # 2. Normalize timestamps
    if [created_at] {
      date {
        match => [ "created_at", "ISO8601", "UNIX_MS" ]
        target => "timestamps.created_at"
      }
    }
    
    if [modified_at] {
      date {
        match => [ "modified_at", "ISO8601", "UNIX_MS" ]
        target => "timestamps.modified_at"
      }
    }
    
    # 3. Add crawl timestamp
    ruby {
      code => '
        event.set("[timestamps][crawl_timestamp]", Time.now.utc.iso8601)
      '
    }
    
    # 4. Normalize location (geo_point)
    if [location][latitude] and [location][longitude] {
      mutate {
        add_field => {
          "[location][geo][lat]" => "%{[location][latitude]}"
          "[location][geo][lon]" => "%{[location][longitude]}"
        }
        convert => {
          "[location][geo][lat]" => "float"
          "[location][geo][lon]" => "float"
        }
      }
    }
    
    # 5. Calculate risk score with Ruby
    ruby {
      code => '
        title = event.get("title").to_s.downcase
        description = event.get("description").to_s.downcase
        text = "#{title} #{description}"
        price = event.get("[price][amount]").to_f
        
        risk_score = 0
        suspicious_keywords = []
        risk_factors = []
        
        # Critical keywords
        critical_legal = ["sin papeles", "sin documentacion", "no papeles"]
        critical_integrity = ["sin itv", "para piezas", "despiece"]
        critical_fraud = ["robo", "importacion", "procedencia dudosa"]
        
        critical_legal.each do |kw|
          if text.include?(kw)
            risk_score += 30
            suspicious_keywords << kw
            risk_factors << "CRITICAL_LEGAL"
          end
        end
        
        critical_integrity.each do |kw|
          if text.include?(kw)
            risk_score += 30
            suspicious_keywords << kw
            risk_factors << "CRITICAL_INTEGRITY"
          end
        end
        
        critical_fraud.each do |kw|
          if text.include?(kw)
            risk_score += 30
            suspicious_keywords << kw
            risk_factors << "CRITICAL_FRAUD"
          end
        end
        
        # General urgency
        urgency_keywords = ["urgente", "solo hoy", "rapido"]
        urgency_keywords.each do |kw|
          if text.include?(kw)
            risk_score += 15
            suspicious_keywords << kw
            risk_factors << "GENERAL_URGENCY"
          end
        end
        
        # Price keywords
        price_keywords = ["ganga", "chollo", "muy barato"]
        price_keywords.each do |kw|
          if text.include?(kw)
            risk_score += 15
            suspicious_keywords << kw
            risk_factors << "GENERAL_PRICE"
          end
        end
        
        # Low price
        if price > 0 and price < 1000
          risk_score += 20
        end
        
        # Short description
        if description.length < 50
          risk_score += 10
        end
        
        # Cap at 100
        risk_score = [risk_score, 100].min
        
        # Store enrichment
        event.set("[enrichment][risk_score]", risk_score)
        event.set("[enrichment][suspicious_keywords]", suspicious_keywords.uniq)
        event.set("[enrichment][risk_factors]", risk_factors.uniq)
        event.set("[enrichment][has_suspicious_keywords]", suspicious_keywords.length > 0)
      '
    }
    
    # 6. Clean up temporary fields
    mutate {
      remove_field => ["@version", "host", "path", "log"]
    }
  }
}
